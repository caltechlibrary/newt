<!DOCTYPE html>
<html lang="en">
<head>
    <title>Newt -- newtrouter_explained</title>
    <link rel="stylesheet" href="https://caltechlibrary.github.io/css/site.css">
    <base href="./">
</head>
<body>
<header>
<a href="https://library.caltech.edu"><img src="https://caltechlibrary.github.io/assets/liblogo.gif" alt="Caltech Library logo"></a>
</header>
<nav>
<ul>
	<li><a href="/">Home</a></li>
	<li><a href="./">README</a></li>
	<li><a href="user_manual.html">User Manual</a></li>
	<li><a href="LICENSE">LICENSE</a></li>
	<li><a href="INSTALL.html">INSTALL</a></li>
	<li><a href="about.html">About</a></li>
	<li><a href="search.html">Search</a></li>
	<li><a href="https://github.com/caltechlibrary/newt">GitHub</a></li>
</ul>
</nav>

<section>
<h1 id="newt-router-explained">Newt router explained</h1>
<h2 id="overview">Overview</h2>
<p>The Newt Router is a data router. A data router takes a request then pass it on to a list one or more services returning the final result. The sequence of contecting one service and using the result as input to another service is called a pipeline. The Unix family of operating systems shells support this concept of piping the output of one program into another program. The Newt router provides a similar service but for routine between one or more web services. Newt was created to be able to route request between PostgREST and a template engine. The second Newt prototype supports this concept for any web service that is reachable via localhost. Typically this is still PostgREST and the Newt Mustache template engine. PostgREST returns JSON data and Newt Mustache can take the JSON data and render an HTML page using a Mustache template. You could swap PostgREST out for Solr and do the same thing. Newt Router supports pipelines of one or more services. The last service to respond has its results passed back to the requesting web browser.</p>
<p>Newt Router does using to concepts, “routes” and “pipelines”. A “route” describes the HTTP method and URL path of a request. The Newt Router using the Newt YAML file can map a requets to a pipeline. Using this approach of defines routes and their pipelines you can compose your web application.</p>
<p>Newt Router can also function as a static web server. This is helpful where your final output is HTML and you wish to also include any related static assets like CSS, images or JavaScript.</p>
<h2 id="a-simple-example">A simple example</h2>
<p>Let’s say we have a database of music albums and reviews. Each album includes a rating of “interesting”. The range is a zero (uninteresting) to five star rating (most interesting). This information is stored in a Postgres database and made available to the Newt Router via PostgREST. Our web application needs to be able to use the PostgREST JSON API to manage our list of albums and reviews. I am going to assume you have a Postgres “view” called “interesting_album_view” defined and that is available via PostgREST via a GET request at the URL “http://localhost:3000/interesting_albums_list”.</p>
<h3 id="prep-work">Prep work</h3>
<p>Before we can run through the tutorial somethings need to be up and running. Postgres 16 and PostgREST 12 needs to be installed. The Postgres database for the demo needs to be installed along with configuration for allowing PostgREST to provide the database content. Here’s an example SQL file you can run to create your Postgres database configured for using with PostgREST. You can retrieve the SQL code to set things up from <a href="https://github.com/caltechlibrary/newt/blob/main/demos/album_reviews/setup_album_reviews_demo.sql" class="uri">https://github.com/caltechlibrary/newt/blob/main/demos/album_reviews/setup_album_reviews_demo.sql</a>. You need to change the password in the file before running the following commands.</p>
<pre class="shell"><code>createdb album_reviews
psql &lt; setup_album_reviews_demo.sql</code></pre>
<p>Similarly you can get an example “postgrest.conf” from <a href="https://github.com/caltechlibrary/newt/blob/main/demos/album_reviews/postgrest.conf" class="uri">https://github.com/caltechlibrary/newt/blob/main/demos/album_reviews/postgrest.conf</a>. You’ll need to set the password to match the one you used in the SQL file setting up the Postgres and PostgREST.</p>
<h3 id="building-our-application">Building our application</h3>
<p>Let’s create a Newt YAML file called “album_reviews.yaml”. Type in the following using your favorite text editor.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="fu">applications</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="at">  </span><span class="fu">newtrouter</span><span class="kw">:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="at">    </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8010</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="at">  </span><span class="fu">postgrest</span><span class="kw">:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="at">    </span><span class="fu">app_path</span><span class="kw">:</span><span class="at"> postgrest</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="at">    </span><span class="fu">conf_path</span><span class="kw">:</span><span class="at"> postgrest.conf</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="fu">routes</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">id</span><span class="kw">:</span><span class="at"> interesting_album_view</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="at">    </span><span class="fu">request</span><span class="kw">:</span><span class="at"> GET /</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="at">    </span><span class="fu">pipeline</span><span class="kw">:</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">service</span><span class="kw">:</span><span class="at"> GET http://localhost:3000/interesting_albums_list</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a><span class="at">        </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Contact PostgREST and get back the intersting album list</span></span></code></pre></div>
<p>You can check to make sure you’ve typed in everything correctly using the command.</p>
<pre class="shell"><code>newt -verbose check album_reviews.yaml</code></pre>
<p>That should show some output like</p>
<pre class="text"><code>WARNING: demos/album_reviews/album_reviews.yaml has no models defined
PostgREST configuration is postgrest.conf
PostgREST will be run with the command &quot;postgrest postgrest.conf&quot;
Newt Router configured, port set to :8010
route interesting_album_view defined, request path GET /interesting_albums_list, pipeline size 1</code></pre>
<p>You can ignore the “WARNING” about models because we’ve already set that up in our Postgres database.</p>
<p>Low let’s run the Newt Router.</p>
<pre class="shell"><code>newt run album_reviews.yaml</code></pre>
<p>Point your web browser at the url <a href="http://localhost:8010/" class="uri">http://localhost:8010/</a>.</p>
<p>You should get back a JSON response that originated from Postgres+PostgREST. It’s not very useful yet. It would be much better if it displayed some HTML.</p>
<h2 id="improving-our-application-by-adding-routes-and-pipelines">Improving our application by adding routes and pipelines</h2>
<p>We can do improve our web application by creating a Mustache templates and setting up Newt Mustache as part of our pipelines.</p>
<p>Add these two Mustache templates from <a href="https://github.com/caltechlibrary/newt/blob/main/demos/album_reviews/review_list.tmpl" class="uri">https://github.com/caltechlibrary/newt/blob/main/demos/album_reviews/review_list.tmpl</a> and <a href="https://github.com/caltechlibrary/newt/blob/main/demos/album_reviews/review_submitted.tmpl" class="uri">https://github.com/caltechlibrary/newt/blob/main/demos/album_reviews/review_submitted.tmpl</a>.</p>
<p>Update the album_reviews.yaml to look like this.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="fu">applications</span><span class="kw">:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="at">  </span><span class="fu">newtrouter</span><span class="kw">:</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="at">    </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8010</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="at">  </span><span class="fu">newtmustache</span><span class="kw">:</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="at">    </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">8011</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a><span class="at">  </span><span class="fu">postgrest</span><span class="kw">:</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="at">    </span><span class="fu">app_path</span><span class="kw">:</span><span class="at"> postgrest</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a><span class="at">    </span><span class="fu">conf_path</span><span class="kw">:</span><span class="at"> postgrest.conf</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a><span class="fu">routes</span><span class="kw">:</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">id</span><span class="kw">:</span><span class="at"> interesting_album_view</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a><span class="at">    </span><span class="fu">request</span><span class="kw">:</span><span class="at"> GET /</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a><span class="at">    </span><span class="fu">pipeline</span><span class="kw">:</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">service</span><span class="kw">:</span><span class="at"> GET http://localhost:3000/interesting_albums_list</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a><span class="at">        </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Contact PostgREST and get back the intersting album list</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">service</span><span class="kw">:</span><span class="at"> POST http://localhost:8011/review_list</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a><span class="at">        </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Convert the JSON into HTML, show the list and web form</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">id</span><span class="kw">:</span><span class="at"> add_a_review</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a><span class="at">    </span><span class="fu">request</span><span class="kw">:</span><span class="at"> POST /add_a_review</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a><span class="at">    </span><span class="fu">pipeline</span><span class="kw">:</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">service</span><span class="kw">:</span><span class="at"> POST http://localhost:3000/rpc/add_a_review</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a><span class="fu">        description</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a>           Add a review via PostgRETS function </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a>           album_reviews.add_a_review</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">service</span><span class="kw">:</span><span class="at"> POST http://localhost:8011/review_submitted</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a><span class="at">        </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Display the submitted review with link back to list</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a><span class="fu">templates</span><span class="kw">:</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">request</span><span class="kw">:</span><span class="at"> /review_list</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true"></a><span class="at">    </span><span class="fu">template</span><span class="kw">:</span><span class="at"> review_list.tmpl</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">request</span><span class="kw">:</span><span class="at"> /review_submitted</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true"></a><span class="at">    </span><span class="fu">template</span><span class="kw">:</span><span class="at"> review_submitted.tmpl</span></span></code></pre></div>
<p>You can check your updated Newt YAML file with the following command.</p>
<pre class="shell"><code>newt -verbose check album_reviews.yaml</code></pre>
<p>This time you should see results like the following.</p>
<pre class="text"><code>WARNING: album_reviews.yaml has no models defined
PostgREST configuration is postgrest.conf
PostgREST will be run with the command &quot;postgrest postgrest.conf&quot;
Newt Router configured, port set to :8010
route interesting_album_view defined, request path GET /interesting_albums_list, pipeline size 2
route add_a_review defined, request path POST /add_a_review, pipeline size 2
Newt Mustache configured, port set to 8011
2 Mustache Templates are defined
http://localhost8011/review_list points at review_list.tmpl
http://localhost8011/review_submitted points at review_submitted.tmpl</code></pre>
<p>If this matches what you’ve see we’re ready to run Newt again with our updated templates and YAML file.</p>
<pre class="shell"><code>newt run album_reviews.yaml</code></pre>
<p>Point your web browser at <a href="http://localhost:8010" class="uri">http://localhost:8010</a>. You should see an empty album list. You can add a review in the form and that should take you to a page showing the added review. Click the link to return to the list and see the revised results.</p>
<h2 id="what-have-we-done-exactly">What have we done exactly?</h2>
<p>First we’ve built up a simple web appliction through defining some routes with data pipelines. In our first iteration we just verified that we could conntect to PostgREST in our first pipeline. It was uninstesting because what is returned in a JSON and specifically an empty JSON list. Not very exciting.</p>
<p>In the second iteration we use the Newt Router to run two routes. The first one listed our review list like before but this time the results were displayed as a web page (i.e. HTML markup). This was accomplished by adding Newt Mustache to our first router as the last stage of our pipeline.</p>
<p>We also added support for a second route that handled the web form submission then returned and displayed the results.</p>
</section>

<footer>
<span><h1><A href="http://caltech.edu">Caltech</a></h1></span>
<span>&copy; 2023-2024 <a href="https://www.library.caltech.edu/copyright">Caltech library</a></span>
<address>1200 E California Blvd, Mail Code 1-32, Pasadena, CA 91125-3200</address> 
<span>Phone: <a href="tel:+1-626-395-3405">(626)395-3405</a></span>
<span><a href="mailto:library@caltech.edu">Email Us</a></span>
<a class="cl-hide" href="sitemap.xml">Site Map</a>
</footer>
</body>
</html>

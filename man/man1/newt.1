.\" Automatically generated by Pandoc 3.0
.\"
.\" Define V font for inline verbatim, using C font in formats
.\" that render this, and otherwise B font.
.ie "\f[CB]x\f[]"x" \{\
. ftr V B
. ftr VI BI
. ftr VB B
. ftr VBI BI
.\}
.el \{\
. ftr V CR
. ftr VI CI
. ftr VB CB
. ftr VBI CBI
.\}
.TH "newt" "1" "" "user manual" "Version 0.0.1 f75250d"
.hy
.SH NAME
.PP
newt
.SH SYNOPSIS
.PP
newt [CONFIG_FILE]
.SH DESCRIPTION
.PP
\f[B]newt\f[R] is a microservice designed to work along side Postgres,
PostgREST, and Pandoc server.
It provides URL routing and data flow between the microservices based on
a list of \[lq]routes\[rq] described in a YAML file.
\f[B]newt\f[R] first sends requests to a JSON data source then processes
the results via Pandoc running as a web service.
While \f[B]newt\f[R] was created to work specifically with PostgREST it
can actually talk to any JSON data source that can be specified by a URL
and HTTP method (e.g.\ Solr, Elasticsearch, Opensearch).
.PP
Before contacting the JSON data source the request path and any form
data is validated based on the request path and any variables defined
for the route.
If validation is successful values are extracted from the request path
along with form data.
These are then used to make a request to a JSON data source
(e.g.\ PostgREST) described in our route definition.
.PP
When the data source replies the results can be fed through Pandoc
running as a web service based on a template filename associated with
the route.
If no template file is specified then the results of the JSON data
source is passed directly back to the web browser (or requesting
service).
.PP
Additionally \f[B]newt\f[R] can function as a static content web
service.
This is handy when developing a \f[B]newt\f[R] based project.
A typical setup might include running Postgres, PostgREST and Pandoc
server along with \f[B]newt\f[R] as you develop your project.
Since \f[B]newt\f[R] always works as a \[lq]localhost\[rq] service you
will need to proxy to it when deploying to a production setting
(e.g.\ via Apache2 or NginX).
.PP
\f[B]newt\f[R]\[cq]s configuration uses a declaritive model expressed in
YAML.
It can also allow environment variables read at start up to be part of
the data for mapping JSON data source requests.
This is particularly helpful for supplying access credentials.
You do not express secrets in the \f[B]newt\f[R] YAML configuration
file.
This follows the best practice used when working with container services
and Lambda like systems.
.SH OPTIONS
.TP
-help
display help
.TP
-license
display license
.TP
-version
display version
.TP
-dry-run
Load YAML configuration and report any errors found
.SH CONFIGURATION
.PP
\f[B]newt\f[R] looks for four environment variables at startup.
.TP
NEWT_PORT
(optional) The port Newt will listen for requests
.TP
NEWT_CONFIG
(optional) The name of a YAML file holding newt configuration
.TP
NEWT_ENV
(optional) The names of environment variables \f[B]newt\f[R] can make
available when setting up route handling.
.TP
NEWT_HTDOCS
(optional) The directory holding static content that Newt will serve
alonside any defined data routes specified in the configuration.
.PP
Example environment expressed in sh.
.IP
.nf
\f[C]
export NEWT_PORT=\[dq]8001\[dq]
export NEWT_ROUTES=\[dq]routes.yaml\[dq]
export NEWT_ENV=\[dq]DB_NAME;DB_USER;DB_PASSWORD\[dq]
export NEWT_HTDOCS=\[dq]/var/local/html/htdocs\[dq]
\f[R]
.fi
.PP
These can also be expressed directly in the YAML configuration file
using the following attribute names \[en] \[lq]port\[rq],
\[lq]routes\[rq], \[lq]env\[rq], and \[lq]htdocs\[rq].
.IP
.nf
\f[C]
port: 8001
routes: routes.yaml
env: [ \[dq]DB_NAME\[dq], \[dq]DB_USER\[dq], \[dq]DB_PASSWORD\[dq] ]
htdocs: /var/local/html/htdocs
\f[R]
.fi
.PP
The environment will load first then the configuration file.
The configuration file takes precedence over the environment.
.PP
\f[B]newt\f[R] does not contain secrets.
These should be passed in via the environment.
This follows the practices that have become commonplace when using
containers and Lamdda like services.
.PP
Avoiding secrets allows your routes in the YAML file to be safely
included in your project source repository along side any Pandoc
templates and SQL source included in your project\[cq]s source code
repository.
.SH Routing data
.PP
For \f[B]newt\f[R] to function as a data router it needs information
about which requests will be serviced and how to map them to a JSON
source before (optionally) sending to Pandoc.
.PP
The routes are held in YAML file under the \[lq]routes\[rq] attribute.
The following attributes are supported for a route.
.TP
var
One or more variable name and type pairs used in request path or form
data.
The types allow for data validation.
.TP
req_path
This is the URL path to watch for incoming requests, it may be a literal
path or one containing variable declarations used in forming a HTTP call
to a JSON source.
.TP
req_method
This is the HTTP method to listen for \[en] \[lq]GET\[rq],
\[lq]POST\[rq], \[lq]PUT\[rq], \[lq]PATCH\[rq] or \[lq]DELETE\[rq].
.TP
api_url
This is the URL used to connect to the JSON data source
(e.g.\ PostgREST, Solr, Elasticsearch).
It may contain defined variables embedded in the request path or form
form data.
.TP
api_method
This is the HTTP method used to access the JSON data source.
Maybe \[lq]OPTIONS\[rq], \[lq]GET\[rq], \[lq]POST\[rq], \[lq]PUT\[rq],
\[lq]PATCH\[rq] or \[lq]DELETE\[rq]
.TP
api_content_type
This is the HTTP content type string to send with your JSON data source
request, typically it is \[lq]application/json\[rq].
.TP
pandoc_template
If included Newt will load the Pandoc template file into memory and use
it when results are returned from a JSON data source.
The data is provided to the Pandoc template as part of the
\[lq]body\[rq] pandoc template variable.
.TP
res_headers
This is any additional HTTP headers you want to send back to the client.
.SH Defining variables
.PP
Each route can have its own associated set of variables.
Variables are \[lq]typed\[rq].
The code for type definitions includes validation.
When a variable is detected in a request path or form data it is vetted
using it\[cq]s associated type.
Only if the variables past validation are they allowed to be used to
assemble a request to a JSON data source.
.PP
Variables are defined in the YAML \[lq]var\[rq] attribute.
Here\[cq]s an example \[lq]var\[rq] definition defining three form
variables for a route.
The variable names are \[lq]bird\[rq], \[lq]place\[rq] and
\[lq]sighted\[rq] with the types \[lq]String\[rq], \[lq]String\[rq] and
\[lq]Date\[rq].
.IP
.nf
\f[C]
var: { \[dq]bird\[dq]: \[dq]String\[dq], \[dq]place\[dq]: \[dq]String\[dq], \[dq]sighted\[dq]: \[dq]Date\[dq] }
\f[R]
.fi
.PP
If a web browser injected additional form values they would not get
passed along via the JSON data API request, they would be ignored.
This is part of the declaritive approach for defining Newt\[cq]s
behavior.
.PP
The variables \[lq]bird\[rq], \[lq]place\[rq] and \[lq]sighted\[rq] can
be used when specifying a request route.
Variables that are defined in a route are delimited by an opening `${'
and closing `}'.
In the following example the URL could represent browsing birds by place
and date sighted.
.IP
.nf
\f[C]
/birds/${place}/${sighted}
/birds/${place}/${sighted}/${bird}
\f[R]
.fi
.PP
This might be used to make a request to a JSON data source
(e.g.\ PostgREST) like this.
.IP
.nf
\f[C]
https://localhost:3000/sightings?bird=${bird}&place=${place}&sighted=${sighted}
\f[R]
.fi
.PP
The result of the JSON source request could then be processed with a
Pandoc template to render an HTML page.
.SH Variable types
.TP
String
Any sequence of characters.
If the variabe is embedded in a path then \[lq]/\[rq] will be used to
delimited path parts and would not be passed into the variables value.
.TP
Date
(default) A year, month, day string like 2006-01-02
.TP
Date 2006
A four digit year (e.g.\ 2023)
.TP
Date 01
A two digit month (e.g.\ \[lq]01\[rq] for January, \[lq]10\[rq] for
October)
.TP
Date 02
A two digit day (e.g.\ \[lq]01\[rq] for the first, \[lq]11\[rq] for the
eleventh)
.TP
Basename
A file\[cq]s basename (filename without an extension)
.TP
Extname
A file\[cq]s extension (e.g.\ \[lq].html\[rq], \[lq].txt\[rq],
\[lq].rss\[rq], \[lq].js\[rq])
.TP
Isbn10
An ten digit ISBN
.TP
Isbn13
A thirteen digit ISBN
.TP
Isbn
An ISBN (either 10 ro 13 digit)
.TP
Issn
An ISSN
.TP
DOI
A DOI (digital object identifier)
.TP
Isni
An ISNI
.TP
ORCID
An ORCID identifier
.PP
NOTE: The current names associated with types will likely change as the
prototype \f[B]newt\f[R] evolves.
It is planned for them to be stable if and when we get to a v1 release
(e.g.\ when we\[cq]re out of the prototype phase).
.SH Pandoc, Pandoc templates
.PP
Values received from the JSON data source are passed to the Pandoc
template bound to the variable name \[lq]data\[rq].
This is done by taking the JSON recieved and forming a front matter
document that is then used alongside Pandoc template in the POST request
made to Pandoc running in server mode.
See <https://pandoc.org/pandoc-server.html> and
<https://pandoc.org/MANUAL.html#templates> for details.
.SH EXAMPLES
.PP
Running \f[B]newt\f[R] with a YAML configuration file called
\[lq]blog.yaml\[rq]
.IP
.nf
\f[C]
newt blog.yaml
\f[R]
.fi
.PP
An example of a YAML file describing blog like application based on
Postgres+PostgREST.
.IP
.nf
\f[C]
env: [ \[dq]DB_USER\[dq], \[dq]DB_PASSWORD\[dq] ]
htdocs: htdocs
routes:
  - var: [ \[dq]yr\[dq]: \[dq]Date 2006\[dq], \[dq]mo\[dq]: \[dq]Date 01\[dq], \[dq]dy\[dq]: \[dq]Date 02\[dq] }
    req_path: \[dq]/blog/${yr}/${mo}/${dy}\[dq]
    req_method: GET
    api_url: \[dq]http://${DB_USER}:${DB_PASSWORD}\[at]localhost:3000/posts?year=${yr}&month=${mo}&day=${dy}\[dq]
    api_method: GET
    api_content_type: \[dq]application/json\[dq]
    pandoc_template: article_list.tmpl
    res_headers: { \[dq]content-type\[dq]: \[dq]text/html\[dq] }
  - var: [ \[dq]yr\[dq]: \[dq]Year\[dq], \[dq]mo\[dq]: \[dq]Month\[dq], \[dq]dy\[dq]: \[dq]Day\[dq] }
    req_path: \[dq]/blog/${yr}/${mo}/${dy}/${title-slug}\[dq]
    req_method: GET
    api_url\[dq]: \[dq]http://${DB_USER}:${DB_PASSWORD}\[at]localhost:3000/posts?year=${yr}&month=${mo}&day=${dy}&title-slug=${title-slug}\[dq]
    pandoc_template: article.tmpl
    res_headers: { \[dq]content-type\[dq]: \[dq]text/html\[dq] }
\f[R]
.fi
.SH AUTHORS
R. S. Doiel.
